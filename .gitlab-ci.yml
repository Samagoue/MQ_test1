# GitLab CI/CD Pipeline for MQ CMDB Automation System
#
# Required CI/CD Variables (Settings > CI/CD > Variables):
#   - UnlockKey: Master password for encrypted database credentials (masked)
#
# Optional Variables:
#   - EMAIL_ENABLED: Set to 'true' to enable email notifications
#   - EMAIL_RECIPIENTS: Comma-separated list of email recipients
#   - SMTP_SERVER, SMTP_PORT, SMTP_FROM, SMTP_USE_TLS, SMTP_PASSWORD
#
# Note: GraphViz is NOT installed on GitLab runners - PDF generation is skipped

stages:
  - validate
  - test
  - package
  - deploy

variables:
  PYTHON_VERSION: "3.9"
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"

# Cache pip dependencies between jobs
cache:
  paths:
    - .cache/pip/
    - venv/

# ------------------------------------------------------------------------------
# Validate Stage - Check code quality and syntax
# ------------------------------------------------------------------------------
validate:syntax:
  stage: validate
  image: python:${PYTHON_VERSION}
  script:
    - echo "Validating Python syntax..."
    - python -m py_compile orchestrator.py
    - python -m py_compile db_export.py
    - python -m py_compile main.py
    - python -m py_compile config/settings.py
    - python -m py_compile processors/mqmanager_processor.py
    - python -m py_compile processors/hierarchy_mashup.py
    - python -m py_compile processors/change_detector.py
    - python -m py_compile processors/deduplication.py
    - python -m py_compile analytics/gateway_analyzer.py
    - python -m py_compile utils/email_notifier.py
    - python -m py_compile utils/file_io.py
    - python -m py_compile utils/common.py
    - python -m py_compile tools/send_email.py
    - echo "Syntax validation passed"
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_BRANCH

validate:json:
  stage: validate
  image: python:${PYTHON_VERSION}
  script:
    - echo "Validating JSON input files..."
    - python -c "import json, glob; [print('Checking ' + f) or json.load(open(f)) and print('  Valid') for f in glob.glob('input/*.json')]"
    - echo "JSON validation complete"
  allow_failure: true
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_BRANCH

validate:unlockkey:
  stage: validate
  image: python:${PYTHON_VERSION}
  script:
    - echo "Checking UnlockKey variable..."
    - if [ -z "${UnlockKey}" ]; then echo "WARNING - UnlockKey variable is not set"; echo "Go to Settings > CI/CD > Variables and add UnlockKey"; else echo "UnlockKey is configured (masked)"; fi
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_BRANCH

# ------------------------------------------------------------------------------
# Test Stage - Run tests and verify imports
# ------------------------------------------------------------------------------
test:imports:
  stage: test
  image: python:${PYTHON_VERSION}
  before_script:
    - python -m venv venv
    - source venv/bin/activate
    - pip install --upgrade pip
    - pip install -r requirements.txt
  script:
    - echo "Testing module imports..."
    - python -c "from config.settings import Config; print('Config OK')"
    - python -c "from processors.mqmanager_processor import MQManagerProcessor; print('MQManagerProcessor OK')"
    - python -c "from processors.hierarchy_mashup import HierarchyMashup; print('HierarchyMashup OK')"
    - python -c "from processors.change_detector import ChangeDetector; print('ChangeDetector OK')"
    - python -c "from analytics.gateway_analyzer import GatewayAnalyzer; print('GatewayAnalyzer OK')"
    - python -c "from utils.email_notifier import EmailNotifier; print('EmailNotifier OK')"
    - python -c "from utils.file_io import load_json, save_json; print('file_io OK')"
    - python -c "from orchestrator import MQCMDBOrchestrator; print('Orchestrator OK')"
    - echo "All imports successful"
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_BRANCH

test:config:
  stage: test
  image: python:${PYTHON_VERSION}
  before_script:
    - python -m venv venv
    - source venv/bin/activate
    - pip install --upgrade pip
    - pip install -r requirements.txt
  script:
    - echo "Testing configuration and directory setup..."
    - python -c "from config.settings import Config; print('BASE_DIR:', Config.BASE_DIR); print('INPUT_DIR:', Config.INPUT_DIR); print('OUTPUT_DIR:', Config.OUTPUT_DIR); Config.ensure_directories(); print('Directories created successfully')"
    - python -c "from config.settings import Config; files = [('gateways.json', Config.GATEWAYS_JSON), ('app_to_qmgr.json', Config.APP_TO_QMGR_JSON), ('org_hierarchy.json', Config.ORG_HIERARCHY_JSON)]; [print(n + ' exists=' + str(p.exists())) for n,p in files]"
    - echo "Configuration test passed"
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_BRANCH

test:processor:
  stage: test
  image: python:${PYTHON_VERSION}
  before_script:
    - python -m venv venv
    - source venv/bin/activate
    - pip install --upgrade pip
    - pip install -r requirements.txt
  script:
    - echo "Testing MQ Manager Processor with sample data..."
    - python tests/test_processor.py
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_BRANCH

test:email:
  stage: test
  image: python:${PYTHON_VERSION}
  before_script:
    - python -m venv venv
    - source venv/bin/activate
    - pip install --upgrade pip
    - pip install -r requirements.txt
  script:
    - echo "Testing email notifier configuration..."
    - python -c "from utils.email_notifier import EmailNotifier, EmailConfig; c = EmailConfig.from_env(); print('SMTP Server:', c.smtp_server); print('Enabled:', c.enabled); n = EmailNotifier(); print('Notifier enabled:', n.is_enabled)"
    - echo "Email notifier test passed"
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_BRANCH

# ------------------------------------------------------------------------------
# Package Stage - Create deployment archive
# ------------------------------------------------------------------------------
package:archive:
  stage: package
  image: python:${PYTHON_VERSION}
  script:
    - echo "Creating deployment package..."
    - mkdir -p dist
    - tar -czvf dist/mqcmdb-${CI_COMMIT_SHORT_SHA}.tar.gz --exclude='.git' --exclude='dist' --exclude='venv' --exclude='.cache' --exclude='*.pyc' --exclude='__pycache__' --exclude='output/*' --exclude='logs/*' --exclude='credentials/*' --exclude='*.enc' --exclude='*.salt' .
    - ls -la dist/
    - echo "Package created - dist/mqcmdb-${CI_COMMIT_SHORT_SHA}.tar.gz"
  artifacts:
    paths:
      - dist/
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_TAG

# ------------------------------------------------------------------------------
# Deploy Stage - Deploy to server (manual trigger)
# ------------------------------------------------------------------------------
deploy:prepare:
  stage: deploy
  image: python:${PYTHON_VERSION}
  before_script:
    - python -m venv venv
    - source venv/bin/activate
    - pip install --upgrade pip
    - pip install -r requirements.txt
  script:
    - echo "Preparing deployment..."
    - if [ -z "${UnlockKey}" ]; then echo "ERROR - UnlockKey not set"; exit 1; fi
    - export DB_MASTER_PASSWORD="${UnlockKey}"
    - echo "DB_MASTER_PASSWORD set from UnlockKey"
    - mkdir -p output/data output/diagrams output/reports output/exports logs
    - python -c "from config.settings import Config; import os; print('DB_MASTER_PASSWORD configured:', bool(os.environ.get('DB_MASTER_PASSWORD'))); Config.ensure_directories(); print('Ready for deployment')"
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: manual
  allow_failure: true

# ------------------------------------------------------------------------------
# Manual Run - Test orchestrator (without database)
# ------------------------------------------------------------------------------
manual:test-orchestrator:
  stage: deploy
  image: python:${PYTHON_VERSION}
  before_script:
    - python -m venv venv
    - source venv/bin/activate
    - pip install --upgrade pip
    - pip install -r requirements.txt
  script:
    - echo "Testing orchestrator initialization..."
    - export DB_MASTER_PASSWORD="${UnlockKey:-test_password}"
    - export PYTHONIOENCODING=utf-8
    - mkdir -p output/data output/diagrams/topology output/diagrams/individual output/diagrams/applications output/diagrams/filtered output/reports output/exports logs
    - python tests/test_orchestrator.py
  artifacts:
    paths:
      - logs/
    expire_in: 7 days
    when: always
  rules:
    - if: $CI_COMMIT_BRANCH
      when: manual
  allow_failure: true

# ------------------------------------------------------------------------------
# Scheduled Pipeline - For future server deployment
# ------------------------------------------------------------------------------
scheduled:full-pipeline:
  stage: deploy
  image: python:${PYTHON_VERSION}
  before_script:
    - python -m venv venv
    - source venv/bin/activate
    - pip install --upgrade pip
    - pip install -r requirements.txt
  script:
    - echo "Running scheduled pipeline..."
    - export DB_MASTER_PASSWORD="${UnlockKey}"
    - export PYTHONIOENCODING=utf-8
    - export EMAIL_ENABLED="${EMAIL_ENABLED:-false}"
    - mkdir -p output/data output/diagrams output/reports output/exports logs
    - echo "Environment configured"
    - echo "EMAIL_ENABLED - ${EMAIL_ENABLED}"
    - python -c "from config.settings import Config; Config.ensure_directories(); print('Ready for scheduled execution')"
  artifacts:
    paths:
      - output/
      - logs/
    expire_in: 30 days
    when: always
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
  allow_failure: true
